@model HotelWebsite.Models.Booking
@{
    ViewData["Title"] = "Book a Room";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var room = ViewBag.Room as HotelWebsite.Models.Room;
    var savedPaymentMethods = ViewBag.SavedPaymentMethods as List<string> ?? new List<string>();
}

<div class="container py-5">
    <!-- Page Title -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold text-primary">Book Your Perfect Stay</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/Rooms">Rooms</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Book a Room</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Booking Form Section -->
        <div class="col-lg-8">
            <!-- Room Details Card -->
            <div class="card border-0 shadow-sm mb-4 rounded-custom">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-5">
                            <img src="@room.ImageUrl" class="img-fluid h-100 rounded-start" style="object-fit: cover;" alt="@room.Type Room">
                        </div>
                        <div class="col-md-7 p-4">
                            <span class="badge bg-primary mb-2">@room.Type Room</span>
                            <h3 class="mb-2">Room @room.RoomNumber</h3>
                            <p class="mb-3">@room.Description</p>
                            <div class="d-flex flex-wrap gap-3 mb-3">
                                <div class="feature d-flex align-items-center">
                                    <i class="fas fa-user-friends text-primary me-2"></i>
                                    <span>@room.Capacity guests</span>
                                </div>
                                <div class="feature d-flex align-items-center">
                                    <i class="fas fa-wifi text-primary me-2"></i>
                                    <span>Free WiFi</span>
                                </div>
                                <div class="feature d-flex align-items-center">
                                    <i class="fas fa-coffee text-primary me-2"></i>
                                    <span>Breakfast</span>
                                </div>
                            </div>
                            <div class="mt-auto">
                                <h4 class="text-primary mb-0">$@room.Price <span class="text-muted fs-6">/ night</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Booking Form -->
            <div class="card border-0 shadow-sm rounded-custom">
                <div class="card-header bg-white p-4 border-0">
                    <h4 class="mb-0"><i class="fas fa-calendar-check text-primary me-2"></i> Reservation Details</h4>
                </div>
                <div class="card-body p-4">
                    <form asp-action="Create" method="post" id="bookingForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        <input type="hidden" asp-for="RoomId" />

                        <!-- Dates Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">1. Select Your Dates</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="CheckInDate" class="form-label">Check-in Date <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        <input asp-for="CheckInDate" class="form-control" type="date" min="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                                    </div>
                                    <small class="text-muted">Check-in time: 2:00 PM - 10:00 PM</small>
                                    <span asp-validation-for="CheckInDate" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="CheckOutDate" class="form-label">Check-out Date <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        <input asp-for="CheckOutDate" class="form-control" type="date" min="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")" required />
                                    </div>
                                    <small class="text-muted">Check-out time: 7:00 AM - 12:00 PM</small>
                                    <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Guest Details Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">2. Guest Information</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="NumberOfGuests" class="form-label">Number of Guests <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        <select asp-for="NumberOfGuests" class="form-select" required>
                                            @for (int i = 1; i <= room.Capacity; i++)
                                            {
                                                <option value="@i">@i @(i == 1 ? "Guest" : "Guests")</option>
                                            }
                                        </select>
                                    </div>
                                    <small class="text-muted">Maximum capacity: @room.Capacity guests</small>
                                    <span asp-validation-for="NumberOfGuests" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="SpecialRequests" class="form-label">Special Requests</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-concierge-bell"></i></span>
                                        <textarea asp-for="SpecialRequests" class="form-control" rows="1" placeholder="Any special requests or requirements?"></textarea>
                                    </div>
                                    <small class="text-muted">We'll do our best to accommodate your requests</small>
                                    <span asp-validation-for="SpecialRequests" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">3. Payment Information</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="paymentMethod" class="form-label">Payment Method <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-credit-card"></i></span>
                                        <select id="paymentMethod" name="paymentMethod" class="form-select" required>
                                            <option value="">Select payment method</option>
                                            @foreach (var method in savedPaymentMethods)
                                            {
                                                <option value="@method">@method</option>
                                            }
                                            <option value="new">Add new payment method</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6" id="newPaymentMethodDiv" style="display: none;">
                                    <label for="newPaymentMethod" class="form-label">New Payment Method <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-wallet"></i></span>
                                        <select id="newPaymentMethod" class="form-select">
                                            <option value="">Select payment type</option>
                                            <option value="Credit Card">Credit Card</option>
                                            <option value="Debit Card">Debit Card</option>
                                            <option value="PayPal">PayPal</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Cash">Cash</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div id="paymentDetails" style="display: none;">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label for="cardNumber" class="form-label">Card Number <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="far fa-credit-card"></i></span>
                                            <input type="text" id="cardNumber" class="form-control" placeholder="XXXX XXXX XXXX XXXX">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="expiration" class="form-label">Expiration <span class="text-danger">*</span></label>
                                        <input type="text" id="expiration" class="form-control" placeholder="MM/YY">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="cvv" class="form-label">CVV <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" id="cvv" class="form-control" placeholder="XXX">
                                            <span class="input-group-text" data-bs-toggle="tooltip" title="3-digit security code on the back of your card">
                                                <i class="fas fa-question-circle"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="savePaymentMethod" name="savePaymentMethod" value="true">
                                    <label class="form-check-label" for="savePaymentMethod">
                                        Save this payment method for future bookings
                                    </label>
                                </div>
                            </div>
                            
                            <div class="alert alert-info d-flex align-items-center mt-3" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>Your payment information is encrypted and secure. We will not charge your card until check-in.</div>
                            </div>
                        </div>

                        <!-- Terms & Conditions -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="termsCheck" required>
                                <label class="form-check-label" for="termsCheck">
                                    I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">terms and conditions</a>
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-controller="Rooms" asp-action="Index" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Back to Rooms
                            </a>
                            <button type="submit" class="btn btn-primary" id="confirmBookingBtn">
                                <i class="fas fa-check-circle me-1"></i> Confirm Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Booking Summary -->
            <div class="card border-0 shadow-sm rounded-custom mb-4 sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header bg-primary text-white p-3">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i> Booking Summary</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center pb-3 mb-3 border-bottom">
                        <span class="fw-bold">@room.Type Room</span>
                        <span class="badge bg-primary">Room @room.RoomNumber</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Check-in:</span>
                        <span id="summaryCheckIn">Select date</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Check-out:</span>
                        <span id="summaryCheckOut">Select date</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Guests:</span>
                        <span id="summaryGuests">1</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span>Nights:</span>
                        <span id="numNights">0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Room rate:</span>
                        <span>$@room.Price / night</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Taxes & fees:</span>
                        <span id="taxesFees">$0.00</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3 pt-3 border-top">
                        <strong class="fs-5">Total:</strong>
                        <strong class="fs-5 text-primary" id="totalPrice">$0.00</strong>
                    </div>
                    
                    <div class="alert alert-success mt-3 mb-0 d-flex align-items-center" role="alert">
                        <i class="fas fa-shield-alt me-2"></i>
                        <div>Free cancellation up to 24 hours before check-in</div>
                    </div>
                </div>
            </div>

            <!-- Policy Information -->
            <div class="card border-0 shadow-sm rounded-custom mb-4">
                <div class="card-header bg-primary text-white p-3">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Booking Policy</h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <h6 class="d-flex align-items-center mb-2">
                            <i class="fas fa-calendar-check text-primary me-2"></i> Check-in/Check-out
                        </h6>
                        <p class="small mb-0">Check-in: 2:00 PM - 10:00 PM</p>
                        <p class="small mb-0">Check-out: 7:00 AM - 12:00 PM</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="d-flex align-items-center mb-2">
                            <i class="fas fa-credit-card text-primary me-2"></i> Payment
                        </h6>
                        <p class="small mb-0">Full payment is required at the time of booking.</p>
                        <p class="small mb-0">We accept Credit Cards, PayPal, and Bank Transfers.</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="d-flex align-items-center mb-2">
                            <i class="fas fa-ban text-primary me-2"></i> Cancellation
                        </h6>
                        <p class="small mb-0">Free cancellation up to 24 hours before check-in.</p>
                        <p class="small mb-0">Cancellations within 24 hours of check-in may be charged a one-night fee.</p>
                    </div>
                    <div>
                        <h6 class="d-flex align-items-center mb-2">
                            <i class="fas fa-info-circle text-primary me-2"></i> Additional Information
                        </h6>
                        <p class="small mb-0">Pets are not allowed.</p>
                        <p class="small mb-0">Smoking is not permitted in the rooms.</p>
                        <p class="small mb-0">ID verification required at check-in.</p>
                    </div>
                </div>
            </div>

            <!-- Need Help Card -->
            <div class="card border-0 shadow-sm rounded-custom">
                <div class="card-body p-4">
                    <h5 class="mb-3 text-primary"><i class="fas fa-headset me-2"></i> Need Help?</h5>
                    <p class="card-text">Have questions about your booking? Contact our support team:</p>
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-phone text-primary me-3"></i>
                        <span>+63 32 123 4567</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-envelope text-primary me-3"></i>
                        <a href="mailto:support@matrixhotel.com">support@matrixhotel.com</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>1. Reservation and Payment Policy</h6>
                <p>Full payment is required at the time of booking to secure your reservation. Your card will be authorized but not charged until check-in.</p>
                
                <h6>2. Cancellation Policy</h6>
                <p>Free cancellation is available up to 24 hours before your scheduled check-in time. Cancellations made within 24 hours of check-in may be subject to a fee equivalent to one night's stay.</p>
                
                <h6>3. Check-in and Check-out Times</h6>
                <p>Check-in is available from 2:00 PM to 10:00 PM. Check-out time is between 7:00 AM and 12:00 PM. Late check-out may result in additional charges.</p>
                
                <h6>4. Damage and Incidentals</h6>
                <p>You are responsible for any damage to the room or hotel property during your stay. Additional charges may apply for any damage or excessive cleaning required.</p>
                
                <h6>5. Age Requirement</h6>
                <p>Guests must be at least 18 years of age to check in without an accompanying adult.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Form elements
            const checkInDateInput = document.getElementById('CheckInDate');
            const checkOutDateInput = document.getElementById('CheckOutDate');
            const guestsSelect = document.getElementById('NumberOfGuests');
            const paymentMethodSelect = document.getElementById('paymentMethod');
            const newPaymentMethodDiv = document.getElementById('newPaymentMethodDiv');
            const newPaymentMethodSelect = document.getElementById('newPaymentMethod');
            const paymentDetails = document.getElementById('paymentDetails');
            const termsCheck = document.getElementById('termsCheck');
            const form = document.getElementById('bookingForm');
            const confirmButton = document.getElementById('confirmBookingBtn');
            
            // Summary elements
            const summaryCheckIn = document.getElementById('summaryCheckIn');
            const summaryCheckOut = document.getElementById('summaryCheckOut');
            const summaryGuests = document.getElementById('summaryGuests');
            const numNightsElement = document.getElementById('numNights');
            const taxesFeesElement = document.getElementById('taxesFees');
            const totalPriceElement = document.getElementById('totalPrice');
            
            // Constants
            const pricePerNight = @room.Price;
            const taxRate = 0.12; // 12% tax rate
            
            // Function to format dates nicely
            function formatDate(dateString) {
                if (!dateString) return 'Select date';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            }
            
            // Function to calculate total price
            function calculateTotal() {
                // Get dates
                const checkInDate = checkInDateInput.value ? new Date(checkInDateInput.value) : null;
                const checkOutDate = checkOutDateInput.value ? new Date(checkOutDateInput.value) : null;
                
                // Update summary displays
                summaryCheckIn.textContent = formatDate(checkInDateInput.value);
                summaryCheckOut.textContent = formatDate(checkOutDateInput.value);
                summaryGuests.textContent = guestsSelect.value;
                
                // Calculate nights and costs
                if (checkInDate && checkOutDate && checkOutDate > checkInDate) {
                    // Calculate days
                    const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
                    const days = Math.ceil(timeDiff / (1000 * 3600 * 24));
                    
                    // Update number of nights
                    numNightsElement.textContent = days;
                    
                    // Calculate costs
                    const roomCost = days * pricePerNight;
                    const taxes = roomCost * taxRate;
                    const totalCost = roomCost + taxes;
                    
                    // Update displayed costs
                    taxesFeesElement.textContent = '$' + taxes.toFixed(2);
                    totalPriceElement.textContent = '$' + totalCost.toFixed(2);
                } else {
                    // Reset if dates aren't valid
                    numNightsElement.textContent = '0';
                    taxesFeesElement.textContent = '$0.00';
                    totalPriceElement.textContent = '$0.00';
                }
            }
            
            // Add event listeners to update summary
            checkInDateInput.addEventListener('change', calculateTotal);
            checkOutDateInput.addEventListener('change', calculateTotal);
            guestsSelect.addEventListener('change', function() {
                summaryGuests.textContent = this.value;
            });
            
            // Payment method handling
            paymentMethodSelect.addEventListener('change', function() {
                if (this.value === 'new') {
                    newPaymentMethodDiv.style.display = 'block';
                    paymentDetails.style.display = 'none';
                } else {
                    newPaymentMethodDiv.style.display = 'none';
                    
                    // Show payment details for credit/debit cards
                    if (this.value.includes('Credit Card') || this.value.includes('Debit Card')) {
                        paymentDetails.style.display = 'block';
                    } else {
                        paymentDetails.style.display = 'none';
                    }
                }
            });
            
            if (newPaymentMethodSelect) {
                newPaymentMethodSelect.addEventListener('change', function() {
                    // Show payment details for credit/debit cards
                    if (this.value === 'Credit Card' || this.value === 'Debit Card') {
                        paymentDetails.style.display = 'block';
                    } else {
                        paymentDetails.style.display = 'none';
                    }
                });
            }
            
            // Form validation and submission
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Form validation
                    const checkInDate = new Date(checkInDateInput.value);
                    const checkOutDate = new Date(checkOutDateInput.value);
                    
                    // Reset validation styling
                    checkInDateInput.classList.remove('is-invalid');
                    checkOutDateInput.classList.remove('is-invalid');
                    termsCheck.classList.remove('is-invalid');
                    
                    let isValid = true;
                    
                    // Validate dates
                    if (!checkInDateInput.value) {
                        checkInDateInput.classList.add('is-invalid');
                        isValid = false;
                    } else if (checkInDate < new Date().setHours(0, 0, 0, 0)) {
                        checkInDateInput.classList.add('is-invalid');
                        alert('Check-in date cannot be in the past.');
                        isValid = false;
                    }
                    
                    if (!checkOutDateInput.value) {
                        checkOutDateInput.classList.add('is-invalid');
                        isValid = false;
                    } else if (checkOutDate <= checkInDate) {
                        checkOutDateInput.classList.add('is-invalid');
                        alert('Check-out date must be after check-in date.');
                        isValid = false;
                    }
                    
                    // Validate terms
                    if (!termsCheck.checked) {
                        termsCheck.classList.add('is-invalid');
                        alert('You must agree to the terms and conditions.');
                        isValid = false;
                    }
                    
                    // Process payment method
                    let finalPaymentMethod = paymentMethodSelect.value;
                    if (finalPaymentMethod === 'new') {
                        finalPaymentMethod = newPaymentMethodSelect.value;
                        if (!finalPaymentMethod) {
                            alert('Please select a payment method.');
                            isValid = false;
                        }
                    } else if (!finalPaymentMethod) {
                        alert('Please select a payment method.');
                        isValid = false;
                    }
                    
                    if (!isValid) {
                        return false;
                    }
                    
                    // Update hidden payment method field or create one if it doesn't exist
                    let paymentMethodInput = document.querySelector('input[name="paymentMethod"][type="hidden"]');
                    if (!paymentMethodInput) {
                        paymentMethodInput = document.createElement('input');
                        paymentMethodInput.type = 'hidden';
                        paymentMethodInput.name = 'paymentMethod';
                        form.appendChild(paymentMethodInput);
                    }
                    paymentMethodInput.value = finalPaymentMethod;
                    
                    // Disable submit button to prevent double submission
                    confirmButton.disabled = true;
                    confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
                    
                    // Submit the form
                    form.submit();
                });
            }
            
            // Run initial calculation
            calculateTotal();
        });
    </script>
}